#!/bin/sh
# Unified entry point for PX4 simulation testing

set -eu

SCRIPT_DIR=$(CDPATH= cd -- "$(dirname "$0")" && pwd)
REPO_ROOT=$(CDPATH= cd -- "$SCRIPT_DIR/.." && pwd)
PX4_DIR="$REPO_ROOT/px4"
PX4_BUILD_DIR="$PX4_DIR/build/px4_sitl_default"

print_usage() {
  cat <<'USAGE'
Usage: simtest [build|run|collect|doctor|all|--help]
  build     Build PX4, models, dependencies
  run       Run the Gazebo simulation
  collect   Fetch artifacts (logs, flight results)
  doctor    Validate environment prerequisites
  all       Execute build + run + collect
USAGE
}

log() {
  printf '[simtest] %s\n' "$1"
}

require_cmd() {
  if ! command -v "$1" >/dev/null 2>&1; then
    log "error: $1 not found, please install with apt"
    exit 1
  fi
}

cleanup_sim_processes() {
  pkill -f "$PX4_BUILD_DIR/bin/px4" >/dev/null 2>&1 || true
  pkill -f "gz sim" >/dev/null 2>&1 || true
  pkill -f "cmake --build .* gz_" >/dev/null 2>&1 || true
}

jobs_count() {
  if command -v nproc >/dev/null 2>&1; then
    nproc
  else
    getconf _NPROCESSORS_ONLN 2>/dev/null || echo 1
  fi
}

run_build() {
  log "PX4 directory: $PX4_DIR/"

  if [ ! -d "$PX4_DIR" ]; then
    log "error: PX4 directory not found at $PX4_DIR/"
    exit 1
  fi

  require_cmd cmake
  require_cmd make

  jobs=$(jobs_count)
  if [ -z "$jobs" ] || [ "$jobs" -lt 1 ]; then
    jobs=1
  fi

  log "Building px4_sitl_default with $jobs parallel jobs..."
  if ! (cd "$PX4_DIR" && make -j"$jobs" px4_sitl_default); then
    log "error: make px4_sitl_default failed, check logs"
    exit 1
  fi

  if [ ! -x "$PX4_BUILD_DIR/bin/px4" ]; then
    log "error: px4 binary missing after build"
    exit 1
  fi

  log "Build complete"
}

run_run() {
  if [ ! -d "$PX4_DIR" ]; then
    log "error: PX4 directory not found at $PX4_DIR/"
    exit 1
  fi

  require_cmd timeout
  require_cmd gz
  require_cmd make
  require_cmd python3

  SIM_DURATION=${SIM_DURATION:-45}
  SIM_TIMEOUT_SIGNAL=${SIM_TIMEOUT_SIGNAL:-SIGINT}
  SIM_KILL_AFTER=${SIM_KILL_AFTER:-30}

  SCENARIO_NAME=${SIMTEST_SCENARIO:-takeoff_land}
  SCENARIO_SCRIPT=""
  SCENARIO_PID=""
  SCENARIO_EXIT=0
  SCENARIO_LOG=""
  SCENARIO_SUMMARY=""
  SCENARIO_TAIL_PID=""

  ARTIFACT_DIR=${SIMTEST_ARTIFACT_DIR:-$REPO_ROOT/artifacts}
  mkdir -p "$ARTIFACT_DIR"

  SIM_MODEL_RAW=${PX4_SIM_MODEL:-x500}
  case "$SIM_MODEL_RAW" in
    gz_*) MODEL_TARGET="$SIM_MODEL_RAW" ;;
    *) MODEL_TARGET="gz_${SIM_MODEL_RAW}" ;;
  esac

  if [ "$SCENARIO_NAME" != "none" ]; then
    CANDIDATE="$REPO_ROOT/tests/scenarios/${SCENARIO_NAME}.py"
    if [ -f "$CANDIDATE" ]; then
      SCENARIO_SCRIPT="$CANDIDATE"
    else
      log "warning: scenario script $SCENARIO_NAME not found at $CANDIDATE, skipping"
    fi
  fi

  if [ ! -x "$PX4_BUILD_DIR/bin/px4" ]; then
    log "PX4 build not found, running build first"
    run_build
  fi

  cleanup_sim_processes

  HEARTBEAT_HELPER="$SCRIPT_DIR/mavlink_heartbeat.py"
  HEARTBEAT_PID=""

  cleanup_trap() {
    if [ -n "$HEARTBEAT_PID" ]; then
      kill "$HEARTBEAT_PID" >/dev/null 2>&1 || true
      wait "$HEARTBEAT_PID" >/dev/null 2>&1 || true
      HEARTBEAT_PID=""
    fi
    if [ -n "$SCENARIO_PID" ]; then
      if wait "$SCENARIO_PID"; then
        SCENARIO_EXIT=0
      else
        SCENARIO_EXIT=$?
      fi
      SCENARIO_PID=""
    fi
    if [ -n "$SCENARIO_TAIL_PID" ]; then
      kill "$SCENARIO_TAIL_PID" >/dev/null 2>&1 || true
      wait "$SCENARIO_TAIL_PID" >/dev/null 2>&1 || true
      SCENARIO_TAIL_PID=""
    fi
    cleanup_sim_processes
  }

  trap cleanup_trap INT TERM EXIT

  if [ -f "$HEARTBEAT_HELPER" ] && [ -z "$SCENARIO_SCRIPT" ]; then
    HB_DURATION=$((SIM_DURATION + SIM_KILL_AFTER))
    log "Starting MAVLink heartbeat helper on UDP 14550"
    if python3 "$HEARTBEAT_HELPER" --duration "$HB_DURATION" --rate 2.0 >/dev/null 2>&1 & then
      HEARTBEAT_PID=$!
    else
      log "warning: failed to launch heartbeat helper"
    fi
  fi

  if [ -n "$SCENARIO_SCRIPT" ]; then
    SCENARIO_DELAY=${SIMTEST_SCENARIO_DELAY:-8}
    SCENARIO_LOG="$ARTIFACT_DIR/${SCENARIO_NAME}.log"
    SCENARIO_SUMMARY="$ARTIFACT_DIR/${SCENARIO_NAME}_summary.json"
    : >"$SCENARIO_LOG"
    : >"$SCENARIO_SUMMARY"
    if command -v tail >/dev/null 2>&1; then
      tail -n0 -F "$SCENARIO_LOG" &
      SCENARIO_TAIL_PID=$!
    fi
    log "Starting scenario $SCENARIO_NAME after ${SCENARIO_DELAY}s delay"
    (
      sleep "$SCENARIO_DELAY"
      SIMTEST_SCENARIO_RESULT="$SCENARIO_SUMMARY" python3 -u "$SCENARIO_SCRIPT"
    ) >>"$SCENARIO_LOG" 2>&1 &
    SCENARIO_PID=$!
  fi

  PX4_GZ_MODEL_PATH="$REPO_ROOT/px4-gazebo-models:$PX4_DIR/Tools/simulation/gz/models"
  GZ_SIM_RESOURCE_PATH="$PX4_GZ_MODEL_PATH:$PX4_DIR/Tools/simulation/gz/worlds"

  export PX4_GZ_MODEL_PATH
  export GZ_SIM_RESOURCE_PATH
  export HEADLESS=1
  export PX4_SIM_MODEL="$MODEL_TARGET"

  log "Starting headless Gazebo Harmonic (model=$MODEL_TARGET, run window=${SIM_DURATION}s)..."

  if timeout --foreground --signal="$SIM_TIMEOUT_SIGNAL" --kill-after="$SIM_KILL_AFTER" "$SIM_DURATION" sh -c "cd '$PX4_DIR' && make px4_sitl '$MODEL_TARGET'"; then
    log "Simulation completed cleanly"
  else
    status=$?
    if [ "$status" -eq 124 ] || [ "$status" -eq 137 ] || [ "$status" -eq 143 ]; then
      log "Simulation stopped after ${SIM_DURATION}s window"
    else
      log "error: simulation failed (exit $status), check logs"
      exit 1
    fi
  fi

  trap - INT TERM EXIT
  cleanup_trap

  if [ "$SCENARIO_EXIT" -ne 0 ]; then
    log "error: scenario exited with status $SCENARIO_EXIT"
    exit 1
  fi

  if [ -n "$SCENARIO_SUMMARY" ] && [ -f "$SCENARIO_SUMMARY" ]; then
    log "Scenario summary: $(cat "$SCENARIO_SUMMARY")"
  fi

  latest_log=$(ls -1t "$PX4_DIR"/build/px4_sitl_default/rootfs/log/*/*.ulg "$PX4_DIR"/log/*/*.ulg 2>/dev/null | head -n1 || true)
  if [ -n "$latest_log" ] && [ -f "$latest_log" ]; then
    dest="$ARTIFACT_DIR/$(basename "$latest_log")"
    if cp "$latest_log" "$dest" 2>/dev/null; then
      log "PX4 log archived to $dest"
      if cp "$dest" "$ARTIFACT_DIR/latest_sitl.ulg" 2>/dev/null; then
        log "PX4 canonical log updated at $ARTIFACT_DIR/latest_sitl.ulg"
      else
        log "warning: unable to refresh canonical log at $ARTIFACT_DIR/latest_sitl.ulg"
      fi
    else
      log "warning: unable to copy PX4 log from $latest_log"
    fi
  fi
}

run_collect() {
  ARTIFACT_DIR=${SIMTEST_ARTIFACT_DIR:-$REPO_ROOT/artifacts}

  if [ ! -d "$ARTIFACT_DIR" ]; then
    log "warning: artifact directory not found at $ARTIFACT_DIR/"
    return
  fi

  log "Artifacts located in $ARTIFACT_DIR/"
  if ls -A "$ARTIFACT_DIR" >/dev/null 2>&1; then
    ls "$ARTIFACT_DIR" | sed 's/^/[simtest]   /'
  else
    log "  (empty)"
  fi
}

run_doctor() {
  require_cmd python3

  if python3 "$SCRIPT_DIR/env_requirements.py" check; then
    log "doctor checks passed"
  else
    log "error: environment diagnostics failed"
    exit 1
  fi
}

run_all() {
  run_build
  run_run
  run_collect
}

main() {
  cmd=${1-}

  case "$cmd" in
    build)
      run_build
      ;;
    run)
      run_run
      ;;
    collect)
      run_collect
      ;;
    doctor)
      run_doctor
      ;;
    all)
      run_all
      ;;
    -h|--help)
      print_usage
      ;;
    "")
      print_usage
      exit 1
      ;;
    *)
      printf '[simtest] error: unknown command %s\n' "$cmd" 1>&2
      print_usage 1>&2
      exit 1
      ;;
  esac
}

main "$@"
